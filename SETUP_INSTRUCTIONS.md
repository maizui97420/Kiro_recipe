# 环境配置说明

## 当前错误分析
登录失败错误 `errCode: -501000` 表示云开发环境ID无效或不可访问。错误信息显示环境ID `994f003b-cc00-439e-98f4-0ae5c6b549bf` 被过滤/拒绝。

## 临时解决方案
已将 app.js 中的环境ID配置注释掉，现在会使用默认环境。如果你只有一个云开发环境，这应该可以工作。

## 需要更新的文件和配置

### 1. app.js (第18行)
```javascript
// 当前 (错误)
env: 'your-cloud-env-id',

// 需要改为
env: '你的实际云开发环境ID',
```

### 2. project.config.development.json (第67行)
```json
// 当前 (错误)
"appid": "your-development-app-id",

// 需要改为
"appid": "你的开发环境小程序AppID",
```

### 3. project.config.production.json (第67行)
```json
// 当前 (错误)
"appid": "your-production-app-id",

// 需要改为
"appid": "你的生产环境小程序AppID",
```

### 4. cloudfunctions/config/development.json (第3行)
```json
// 当前 (错误)
"envId": "your-development-env-id",

// 需要改为
"envId": "你的开发环境云开发环境ID",
```

### 5. cloudfunctions/config/production.json (第3行)
```json
// 当前 (错误)
"envId": "your-production-env-id",

// 需要改为
"envId": "你的生产环境云开发环境ID",
```

## 如何获取这些ID

### 获取小程序AppID
1. 访问 [微信小程序管理后台](https://mp.weixin.qq.com)
2. 登录并选择你的小程序
3. 进入"开发" → "开发设置"
4. 复制"AppID"

### 获取云开发环境ID
1. 访问 [微信云开发控制台](https://console.cloud.tencent.com/tcb)
2. 选择你的云环境
3. 从环境详情中复制"环境ID"

## 建议的环境配置策略

### 开发环境
- 使用独立的云开发环境ID
- 可以使用相同的小程序AppID (如果只有一个小程序)

### 生产环境  
- 使用独立的云开发环境ID
- 建议使用独立的小程序AppID (如果有多个环境)

## 配置完成后
1. 重新编译小程序
2. 重新部署云函数
3. 测试登录功能

## 注意事项
- 确保云开发环境已经创建并启用
- 确保云函数已经部署到对应的环境
- 确保小程序已经关联到对应的云开发环境

## 🎉 环境问题已解决！

现在出现新的错误：`Cannot find module 'wx-server-sdk'`
这表示云函数部署时没有安装依赖包。

## 立即解决步骤

### 1. 重新部署云函数（包含依赖）
在微信开发者工具中：
1. 右键点击 `cloudfunctions/login` 文件夹
2. 选择 **"上传并部署：云端安装依赖"** （重要：必须选择"云端安装依赖"）
3. 等待部署完成

### 2. 验证其他云函数
同样需要重新部署其他云函数：
- 右键 `cloudfunctions/dish` → "上传并部署：云端安装依赖"
- 右键 `cloudfunctions/group` → "上传并部署：云端安装依赖"
- 右键 `cloudfunctions/database-init` → "上传并部署：云端安装依赖"

### 3. 重新测试登录
部署完成后，重新测试登录功能

### 2. 检查云开发环境状态
1. 打开微信开发者工具
2. 点击"云开发"按钮
3. 检查是否有可用的云开发环境
4. 确保环境状态为"正常"

### 3. 验证云函数部署状态
1. 在云开发控制台中检查 `login` 云函数是否已部署
2. 查看云函数日志是否有错误
3. **重要**：必须选择"上传并部署：云端安装依赖"，不是普通的"上传并部署"

### 4. 检查数据库权限
1. 在云开发控制台中检查数据库
2. 确保 `users` 集合存在
3. 检查集合的读写权限设置

### 5. 如果需要指定特定环境ID
如果你有多个云开发环境，需要指定特定的环境ID：

```javascript
// 在 app.js 中
wx.cloud.init({
  env: '你的正确环境ID', // 从云开发控制台获取
  traceUser: true,
});
```

## 常见问题排查

### 问题1: 环境ID格式错误
- 环境ID通常是类似 `env-xxxxx` 的格式
- 不是 `994f003b-cc00-439e-98f4-0ae5c6b549bf` 这种UUID格式

### 问题2: 环境不存在或无权访问
- 确保环境ID是从你的账号下的云开发控制台获取的
- 确保小程序AppID与云开发环境关联

### 问题3: 云函数未部署
- 在微信开发者工具中右键云函数文件夹
- 选择"上传并部署：云端安装依赖"

### 问题4: 数据库权限问题
- 检查数据库集合的权限设置
- 确保允许小程序端读写

## 获取正确环境ID的方法

### 方法1: 通过微信开发者工具
1. 打开微信开发者工具
2. 点击"云开发"
3. 在环境列表中查看环境ID

### 方法2: 通过云开发控制台
1. 访问 https://console.cloud.tencent.com/tcb
2. 选择你的环境
3. 在概览页面查看环境ID

## 调试建议

### 1. 查看控制台日志
在微信开发者工具的控制台中查看详细错误信息

### 2. 检查网络请求
在网络面板中查看云函数调用的详细信息

### 3. 简化测试
先测试一个简单的云函数调用，确保基础连接正常

## 如果问题仍然存在
1. 检查微信开发者工具版本是否最新
2. 检查基础库版本是否支持云开发
3. 尝试创建新的云开发环境进行测试

## 🔧 云函数部署详细说明

### 为什么会出现 "Cannot find module" 错误？
- 云函数需要 `wx-server-sdk` 依赖包才能运行
- 如果只选择"上传并部署"，不会安装依赖包
- 必须选择"上传并部署：云端安装依赖"

### 正确的部署步骤
1. **在微信开发者工具中**：
   - 展开 `cloudfunctions` 文件夹
   - 右键点击 `login` 文件夹
   - 选择 **"上传并部署：云端安装依赖"**
   - 等待控制台显示"部署成功"

2. **验证部署成功**：
   - 在云开发控制台中查看云函数列表
   - 确认 `login` 函数状态为"正常"
   - 查看函数详情，确认有依赖包信息

### 如果部署仍然失败
1. **检查网络连接**：确保能访问 npm 仓库
2. **检查开发者工具版本**：更新到最新版本
3. **手动安装依赖**：
   ```bash
   cd cloudfunctions/login
   npm install
   ```
   然后再次上传部署

### 批量部署所有云函数
如果有多个云函数需要部署：
1. 右键 `cloudfunctions` 根文件夹
2. 选择"同步云函数列表"
3. 逐个部署每个云函数（记得选择"云端安装依赖"）

## 预期结果
部署成功后，登录功能应该可以正常工作。如果还有其他错误，可能是数据库权限或其他配置问题。